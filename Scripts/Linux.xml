<?xml version="1.0"?>
<project>
	<target name="winscp.init" unless="${target::has-executed('winscp.init')}">
		<property name="remote.dir" value="${string::replace(string::replace(product.dir, sources.dir, ''), '\', '/')}" />
		<property name="local.dir" value="${product.dir}" />
		<echo>remote.dir: ${remote.dir}</echo>

		<property name="winscp" value="${environment::get-variable('ProgramFiles(x86)')}\winscp\winscp.com" /> <!-- .com file writes correct console -->
		<property name="winscp.sync" value='"synchronize remote ""${local.dir}"" ""${remote.dir}"" -filemask=""|.svn/;*.build"""' />
	</target>
	
	<target name="winscp" depends="winscp.init" >
		<exec program="${winscp}" timeout="1800000" > 
			<arg value='${sshHost}' />
			<arg value='/hostkey="${sshKey}"' /> <!-- may be cached by WinSCP.exe in "%Program Files (x86)%\WinSCP\WinSCP.ini" -->
			<arg value='/command ${winscp.sync} exit' />
		</exec>
	</target>
	
  <target name="winscpAndBackup" depends="winscp.init" >
		<property name="backupImages.dir" value="${backup.dir}\${product.name}\images" />
		<mkdir dir="${backupImages.dir}" />

		<property name="winscp.sync" value='${winscp.sync} "synchronize local ""${backupImages.dir}"" ""${remote.dir}/images"""' />
		<call target="winscp" />

		<call target="wikiBackup" />
	</target>
</project>